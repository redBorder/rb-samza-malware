package net.redborder.samza.processors;

import net.redborder.samza.enrichments.EnrichManager;
import net.redborder.samza.store.StoreManager;
import net.redborder.samza.util.constants.Dimension;
import org.apache.samza.config.Config;
import org.apache.samza.task.MessageCollector;
import org.apache.samza.task.TaskContext;

import java.util.HashMap;
import java.util.Map;

public class IcapProcessor extends Processor {
    public IcapProcessor(StoreManager storeManager, EnrichManager enrichManager, Config config, TaskContext context) {
        super(storeManager, enrichManager, config, context);
    }

    @Override
    public void process(Map<String, Object> message, MessageCollector collector) {
        Map<String, Object> enrichment = (Map<String, Object>) message.get("enrichment");
        Map<String, Object> fileInfo = (Map<String, Object>) message.get("file_info");
        Map<String, Object> toDruid = new HashMap<>();

        if (enrichment != null) {
            toDruid.putAll(enrichment);
        }

        if (fileInfo != null) {
            toDruid.putAll(fileInfo);
        }

        Map<String, Object> icapRequest = (Map<String, Object>) message.get("icap_request_headered");

        if (icapRequest != null) {
            String url = (String) icapRequest.get("url_file");
            String dst = (String) icapRequest.get("X-Client-IP");
            String proxy_ip = (String) icapRequest.get("client-ip");

            if (url != null) {
                toDruid.put(Dimension.URL, url);
            }

            if (dst != null) {
                toDruid.put(Dimension.DST, dst);
            }

            if (proxy_ip != null) {
                toDruid.put(Dimension.PROXY_IP, proxy_ip);
            }
        }

        Map<String, Object> httpRequest = (Map<String, Object>) message.get("http_request_headers");

        if (httpRequest != null) {
            String src = (String) httpRequest.get("host");
            String userAgent = (String) httpRequest.get("user-agent");

            if (src != null) {
                toDruid.put(Dimension.SRC, src);
            }

            if (userAgent != null) {
                toDruid.put(Dimension.HTTP_USER_AGENT_OS, userAgent);
            }

        }
    }

    @Override
    public String getName() {
        return "ICAP";
    }
}
