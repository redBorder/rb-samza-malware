package net.redborder.samza.util;

import org.apache.commons.compress.utils.IOUtils;
import org.apache.http.HttpResponse;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.impl.client.DefaultHttpRequestRetryHandler;
import org.apache.http.params.BasicHttpParams;
import org.apache.http.params.HttpConnectionParams;
import org.apache.http.params.HttpParams;
import org.codehaus.jackson.map.ObjectMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.Map;

public class HttpHelper {

    public enum METHOD_HTTP {
        GET, POST, PUT, PATCH
    }

    private static final Logger log = LoggerFactory.getLogger(HttpHelper.class);
    static ObjectMapper mapper = new ObjectMapper();

    public static HttpResponse lastResponse;

    public static void post(String url, Map<String, Object> parameters) {
        final HttpParams httpParams = new BasicHttpParams();
        HttpConnectionParams.setConnectionTimeout(httpParams, 5000);
        HttpConnectionParams.setSoTimeout(httpParams, 5000);
        DefaultHttpClient httpClient = new DefaultHttpClient(httpParams);
        httpClient.setHttpRequestRetryHandler(new DefaultHttpRequestRetryHandler(0, false));
        HttpPost postRequest = new HttpPost(url);

        try {
            StringEntity input = new StringEntity(mapper.writeValueAsString(parameters));
            input.setContentType("application/json");
            postRequest.setEntity(input);
            log.debug("Sending HTTP Post request");
            lastResponse = httpClient.execute(postRequest);
            log.debug("Response received");
            if (lastResponse.getStatusLine().getStatusCode() != 200) {
                log.warn("[" + METHOD_HTTP.POST.name() + "] : Response with code - {} - Msg: {} - Data: " + parameters,
                        lastResponse.getStatusLine().getStatusCode(),
                        org.apache.commons.io.IOUtils.toString(lastResponse.getEntity().getContent()));

            } else {
                log.info("[" + METHOD_HTTP.POST.name() + "] : Success response");
            }

        } catch (IOException e) {
            e.printStackTrace();
            log.error("", e);
            log.info("Connection refused by server : {}", url.toString());
        }
    }

    public static HttpResponse getLastResult() {
        return lastResponse;
    }

}
